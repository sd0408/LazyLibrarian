<%inherit file="base.html" />
<%!
    import bookbagofholding
%>
<%
    current_page = 'history'
%>
<%def name="headIncludes()">
    <link href="css/datatables.bootstrap5.min.css" rel="stylesheet">
</%def>
<%def name="styleIncludes()">
.ll-progress {
    height: 20px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    min-width: 100px;
    position: relative;
}
.ll-progress-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}
.ll-progress-danger { background: var(--error); }
.ll-progress-warning { background: var(--warning); }
.ll-progress-info { background: var(--info); }
.ll-progress-success { background: var(--success); }
.ll-progress-text {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    color: var(--text);
    font-weight: 500;
}
</%def>
<%def name="body()">
    <div class="ll-page-header">
        <div class="ll-page-header-content">
            <h1 class="ll-page-title">${title}</h1>
            <p class="ll-page-subtitle">View and manage download history</p>
        </div>
        <div class="ll-page-header-actions">
            %if perm&bookbagofholding.perm_status:
            <a href="clearhistory?status=all" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
                Clear All
            </a>
            <a href="clearhistory?status=Processed" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
                Clear Processed
            </a>
            <a href="clearhistory?status=Snatched" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <polyline points="19 12 12 19 5 12"></polyline>
                </svg>
                Clear Snatched
            </a>
            <a href="clearhistory?status=Failed" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                Clear Failed
            </a>
            %endif
            <button class="ll-btn ll-btn-primary" type="button" id="showdownloads">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Download Count
            </button>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="ll-toolbar">
        <div class="ll-toolbar-left">
            %if bookbagofholding.CONFIG['TOGGLES']:
            <span class="ll-toolbar-label">Toggle:</span>
            <div class="ll-btn-group">
                <button type="button" class="ll-btn ll-btn-ghost ll-btn-sm toggle-vis active" data-column="0">Title</button>
                <button type="button" class="ll-btn ll-btn-ghost ll-btn-sm toggle-vis active" data-column="1">Type</button>
                <button type="button" class="ll-btn ll-btn-ghost ll-btn-sm toggle-vis active" data-column="2">ID</button>
                <button type="button" class="ll-btn ll-btn-ghost ll-btn-sm toggle-vis active" data-column="3">Provider</button>
                <button type="button" class="ll-btn ll-btn-ghost ll-btn-sm toggle-vis active" data-column="4">Date</button>
                <button type="button" class="ll-btn ll-btn-ghost ll-btn-sm toggle-vis active" data-column="5">Size</button>
                <button type="button" class="ll-btn ll-btn-ghost ll-btn-sm toggle-vis active" data-column="6">Status</button>
            </div>
            %endif
        </div>
        <div class="ll-toolbar-right">
        </div>
    </div>

    <!-- History List -->
    <div class="ll-card">
        <div class="ll-card-body ll-card-body-flush">
            <div class="table-responsive">
                <table class="ll-table" id="book_table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th style="width: 80px;">Type</th>
                            <th style="width: 100px;">ID</th>
                            <th style="width: 120px;">Provider</th>
                            <th class="text-center" style="width: 100px;">Date</th>
                            <th class="text-end" style="width: 80px;">Size</th>
                            <th class="text-center" style="width: 140px;">Status</th>
                            <th class="hidden">percent</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</%def>
<%def name="javascriptIncludes()">
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/datatables.bootstrap5.min.js"></script>
    <script src="js/natural.js"></script>
    <script src="js/bootbox.min.js"></script>
    <script>
    function dlinfo(target) {
        var res = target.split('^');
        var status = res[0];
        var rowid = res[1];
        $.get('dlinfo', {'target': target}, function(data) {
            bootbox.dialog({
                title: 'Download ' + status,
                message: '<pre style="white-space: pre-wrap; font-size: 0.85rem;">' + data + '</pre>',
                buttons: {
                    bt1: {
                        label: "Mark Failed",
                        className: 'll-btn ll-btn-warning',
                        callback: function() {
                            $.get("markhistory", { 'rowid': rowid }, function(data) {});
                            location.reload(true);
                        }
                    },
                    bt2: {
                        label: "Delete",
                        className: 'll-btn ll-btn-danger',
                        callback: function() {
                            $.get("deletehistory", { 'rowid': rowid }, function(data) {});
                            location.reload(true);
                        }
                    },
                    primary: {
                        label: "Close",
                        className: 'll-btn ll-btn-primary'
                    }
                }
            });
        });
    }

    $(document).ready(function() {
        var timer;

        $('#showdownloads').on('click', function(e) {
            $.get('showdownloads', function(data) {
                bootbox.dialog({
                    title: 'Successful Downloads',
                    message: '<pre style="white-space: pre-wrap; font-size: 0.85rem;">' + data + '</pre>',
                    buttons: {
                        %if perm&bookbagofholding.perm_status:
                        prompt: {
                            label: "Clear Counters",
                            className: 'll-btn ll-btn-danger',
                            callback: function() { $.get("cleardownloads", function(e) {}); }
                        },
                        %endif
                        primary: {
                            label: "Close",
                            className: 'll-btn ll-btn-primary'
                        }
                    }
                });
            });
        });

        var table = $('#book_table').DataTable({
            "responsive": true,
            "bAutoWidth": false,
            "stateSave": true,
            "order": [[ 4, 'desc' ]],
            "columnDefs": [
                { targets: [1],
                    'render': function(data, type, row) {
                        var ftype = row[1];
                        if (ftype == 'None') ftype = 'eBook';
                        return '<span class="ll-badge ll-badge-secondary">' + ftype + '</span>';
                    }
                },
                { targets: [4],
                    'class': 'text-center',
                    'render': function(data, type, row) {
                        return '<a data-bs-toggle="tooltip" title="' + row[11] + '">' + row[4] + '</a>';
                    }
                },
                { targets: [5],
                    'class': 'text-end',
                    'render': function(data, type, row) {
                        return data;
                    }
                },
                { targets: [6],
                    'class': 'text-center',
                    'render': function(data, type, row) {
                        if (row[9] <= 0) {
                            %if perm&bookbagofholding.perm_status:
                            var statusClass = 'secondary';
                            if (data === 'Processed') statusClass = 'success';
                            else if (data === 'Snatched') statusClass = 'primary';
                            else if (data === 'Failed') statusClass = 'danger';
                            return '<button onclick="dlinfo(\'' + data + '^' + row[10] + '\')" class="ll-badge ll-badge-' + statusClass + '" style="cursor: pointer; border: none;">' + data + '</button>';
                            %else:
                            return '<span class="ll-badge ll-badge-secondary">' + data + '</span>';
                            %endif
                        } else {
                            var css = 'danger';
                            if (row[9] > 75) css = 'success';
                            else if (row[9] > 50) css = 'info';
                            else if (row[9] > 25) css = 'warning';
                            return '<div class="ll-progress"><div class="ll-progress-bar ll-progress-' + css + '" style="width: ' + row[9] + '%;"></div><span class="ll-progress-text">' + row[9] + '%</span></div>';
                        }
                    }
                },
                { targets: [7], 'visible': false }
            ],
            "oLanguage": {
                "sSearch": "",
                "sSearchPlaceholder": "Search history...",
                "sLengthMenu": "_MENU_ per page",
                "sEmptyTable": "No history found",
                "sInfo": "Showing _START_ to _END_ of _TOTAL_ entries",
                "sInfoEmpty": "Showing 0 to 0 of 0 entries",
                "sInfoFiltered": "(filtered from _MAX_ total)"
            },
            "bServerSide": true,
            "sAjaxSource": 'getHistory',
            "bFilter": true,
            "sPaginationType": "full_numbers",
            "aLengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            "iDisplayLength": ${bookbagofholding.CONFIG['DISPLAYLENGTH']},
            "fnRowCallback": function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                // Add mobile card classes
                var cells = $('td', nRow);
                cells.eq(0).addClass('mobile-primary');
                cells.eq(1).addClass('mobile-secondary').attr('data-label', 'Type');
                cells.eq(2).addClass('mobile-secondary mobile-hide-small').attr('data-label', 'ID');
                cells.eq(3).addClass('mobile-secondary').attr('data-label', 'Provider');
                cells.eq(4).addClass('mobile-secondary').attr('data-label', 'Date');
                cells.eq(5).addClass('mobile-secondary mobile-hide-small').attr('data-label', 'Size');
                cells.eq(6).addClass('mobile-actions');

                return nRow;
            },
            "aaSorting": [[4, 'desc']]
        });

        // Style DataTables elements
        $('.dataTables_filter input').addClass('ll-input').attr('placeholder', 'Search history...');
        $('.dataTables_length select').addClass('ll-select');

        // Mobile card mode toggle
        function checkMobileCardMode() {
            var table = $('#book_table');
            if (window.innerWidth <= 768) {
                table.addClass('ll-table-mobile-cards');
            } else {
                table.removeClass('ll-table-mobile-cards');
            }
        }

        var resizeTimer;
        $(window).on('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(checkMobileCardMode, 250);
        });
        checkMobileCardMode();

        // Toggle column visibility
        $('button.toggle-vis').click(function(e) {
            e.preventDefault();
            var column = table.column($(this).attr('data-column'));
            column.visible(!column.visible());
            $(this).toggleClass('active');
        });

        // Auto-refresh
        if (timer) {
            clearInterval(timer);
        }
        if (${bookbagofholding.HIST_REFRESH} > 0) {
            timer = setInterval(function() { table.ajax.reload(null, false); }, ${bookbagofholding.HIST_REFRESH});
        }
    });
    </script>
</%def>

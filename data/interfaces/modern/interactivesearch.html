<%inherit file="base.html" />
<%
    import bookbagofholding
    current_page = 'books'
%>

<%def name="headIncludes()">
</%def>

<%def name="styleIncludes()">
.ll-search-header {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--ll-surface);
    border-radius: var(--ll-radius-lg);
    border: 1px solid var(--ll-border);
}

.ll-book-cover {
    width: 120px;
    height: 180px;
    object-fit: cover;
    border-radius: var(--ll-radius);
    box-shadow: var(--ll-shadow-md);
    flex-shrink: 0;
}

.ll-book-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.ll-book-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--ll-text);
    margin: 0;
}

.ll-book-author {
    font-size: 1.1rem;
    color: var(--ll-text-secondary);
    margin: 0;
}

.ll-book-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--ll-text-muted);
}

.ll-search-progress {
    text-align: center;
    padding: 3rem;
    background: var(--ll-surface);
    border-radius: var(--ll-radius-lg);
    border: 1px solid var(--ll-border);
}

.ll-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--ll-border);
    border-top-color: var(--ll-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.ll-results-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--ll-surface);
    border-radius: var(--ll-radius-lg);
    overflow: hidden;
    border: 1px solid var(--ll-border);
}

.ll-results-table th,
.ll-results-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--ll-border);
}

.ll-results-table th {
    background: var(--ll-surface-hover);
    font-weight: 600;
    color: var(--ll-text);
    cursor: pointer;
    user-select: none;
}

.ll-results-table th:hover {
    background: var(--ll-border);
}

.ll-results-table tbody tr:hover {
    background: var(--ll-surface-hover);
}

.ll-results-table tbody tr.blacklisted {
    opacity: 0.5;
    text-decoration: line-through;
    background: var(--ll-surface-hover);
}

.ll-score-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 48px;
    padding: 0.25rem 0.5rem;
    border-radius: var(--ll-radius);
    font-weight: 600;
    font-size: 0.875rem;
}

.ll-score-high {
    background: var(--ll-success-bg);
    color: var(--ll-success);
}

.ll-score-medium {
    background: var(--ll-warning-bg);
    color: var(--ll-warning);
}

.ll-score-low {
    background: var(--ll-error-bg);
    color: var(--ll-error);
}

.ll-mode-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: var(--ll-radius);
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.ll-mode-nzb {
    background: #dbeafe;
    color: #1d4ed8;
}

.ll-mode-torrent, .ll-mode-magnet {
    background: #fef3c7;
    color: #d97706;
}

.ll-mode-direct {
    background: #d1fae5;
    color: #059669;
}

.ll-result-title {
    max-width: 400px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.ll-result-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: nowrap;
}

.ll-no-results {
    text-align: center;
    padding: 3rem;
    color: var(--ll-text-muted);
}

.ll-search-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    gap: 1rem;
    flex-wrap: wrap;
}

.ll-search-filter {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.ll-back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--ll-text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.ll-back-link:hover {
    color: var(--ll-primary);
}

@media (max-width: 768px) {
    .ll-search-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .ll-results-table {
        display: block;
        overflow-x: auto;
    }

    .ll-result-title {
        max-width: 200px;
    }
}
</%def>

<!-- Page Header -->
<a href="authorPage?AuthorID=${book['AuthorID']}&library=${library}" class="ll-back-link">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
    </svg>
    Back to Author
</a>

<div class="ll-page-header">
    <h1 class="ll-page-title">Interactive Search</h1>
    <p class="ll-page-subtitle">Select a result to download for ${library}</p>
</div>

<!-- Book Info Header -->
<div class="ll-search-header">
    <img src="cache/book/${book['BookID']}.jpg"
         alt="${book['BookName']}"
         class="ll-book-cover"
         onerror="this.src='images/nocover.png'">
    <div class="ll-book-info">
        <h2 class="ll-book-title">${book['BookName']}</h2>
        <p class="ll-book-author">by ${book['AuthorName']}</p>
        <div class="ll-book-meta">
            %if book.get('BookDate'):
            <span>Published: ${book['BookDate']}</span>
            %endif
            %if book.get('BookLang'):
            <span>Language: ${book['BookLang']}</span>
            %endif
            %if book.get('BookPages'):
            <span>Pages: ${book['BookPages']}</span>
            %endif
        </div>
        <div style="margin-top: auto; padding-top: 1rem;">
            <span class="ll-badge ll-badge-info">${library}</span>
        </div>
    </div>
</div>

<!-- Search Options -->
<div class="ll-search-options" style="margin-bottom: 1rem; padding: 1rem; background: var(--ll-surface); border-radius: var(--ll-radius-lg); border: 1px solid var(--ll-border);">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
        <input type="checkbox" id="showAllResults" style="width: 18px; height: 18px; cursor: pointer;">
        <span style="font-weight: 500;">Show all results</span>
        <span style="color: var(--ll-text-muted); font-size: 0.875rem;">(ignore category filtering - shows both eBook and AudioBook results)</span>
    </label>
</div>

<!-- Search Progress -->
<div id="searchProgress" class="ll-search-progress">
    <div class="ll-spinner"></div>
    <p>Searching providers...</p>
    <p style="font-size: 0.875rem; color: var(--ll-text-muted);">This may take a moment</p>
</div>

<!-- Results Section (hidden initially) -->
<div id="resultsSection" style="display: none;">
    <div class="ll-search-toolbar">
        <div class="ll-search-filter">
            <input type="text" id="filterInput" class="ll-input ll-input-sm" placeholder="Filter results..." style="width: 250px;">
            <select id="modeFilter" class="ll-select ll-select-sm">
                <option value="">All Types</option>
                <option value="nzb">NZB</option>
                <option value="torrent">Torrent</option>
                <option value="magnet">Magnet</option>
                <option value="direct">Direct</option>
            </select>
        </div>
        <div>
            <span id="resultCount" style="color: var(--ll-text-muted); font-size: 0.875rem;"></span>
            <button id="refreshBtn" class="ll-btn ll-btn-secondary ll-btn-sm" style="margin-left: 1rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Refresh
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="ll-results-table" id="resultsTable">
            <thead>
                <tr>
                    <th data-sort="score" style="width: 80px;">Score</th>
                    <th data-sort="title">Title</th>
                    <th data-sort="provider" style="width: 120px;">Provider</th>
                    <th data-sort="size" style="width: 100px;">Size</th>
                    <th data-sort="mode" style="width: 80px;">Type</th>
                    <th style="width: 200px;">Actions</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
        </table>
    </div>

    <div id="noResults" class="ll-no-results" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="margin-bottom: 1rem; opacity: 0.5;">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <p>No results found</p>
        <p style="font-size: 0.875rem;">Try adjusting your search or check your provider settings</p>
    </div>
</div>

<%def name="javascriptIncludes()">
<script>
(function() {
    'use strict';

    var bookid = '${book["BookID"]}';
    var library = '${library}';
    var allResults = [];
    var sortColumn = 'score';
    var sortDirection = 'desc';

    // Load results on page load
    loadResults();

    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadResults();
    });

    // Show all results checkbox - reload when changed
    document.getElementById('showAllResults').addEventListener('change', function() {
        loadResults();
    });

    // Filter input
    document.getElementById('filterInput').addEventListener('input', debounce(function() {
        renderResults();
    }, 300));

    // Mode filter
    document.getElementById('modeFilter').addEventListener('change', function() {
        renderResults();
    });

    // Table header sorting
    document.querySelectorAll('#resultsTable th[data-sort]').forEach(function(th) {
        th.addEventListener('click', function() {
            var column = this.dataset.sort;
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = column === 'score' ? 'desc' : 'asc';
            }
            renderResults();
        });
    });

    function loadResults() {
        document.getElementById('searchProgress').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';

        var showAll = document.getElementById('showAllResults').checked;

        $.ajax({
            url: 'getInteractiveSearchResults',
            data: {
                bookid: bookid,
                library: library,
                showall: showAll ? '1' : '0'
            },
            dataType: 'json',
            success: function(response) {
                document.getElementById('searchProgress').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';

                if (response.success) {
                    allResults = response.results || [];
                    renderResults();
                } else {
                    window.llToast.show('Error: ' + (response.error || 'Unknown error'), 'error');
                }
            },
            error: function() {
                document.getElementById('searchProgress').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                window.llToast.show('Failed to load search results', 'error');
            }
        });
    }

    function renderResults() {
        var filterText = document.getElementById('filterInput').value.toLowerCase();
        var modeFilter = document.getElementById('modeFilter').value;

        // Filter results
        var filtered = allResults.filter(function(r) {
            if (filterText && r.title.toLowerCase().indexOf(filterText) === -1 &&
                r.provider.toLowerCase().indexOf(filterText) === -1) {
                return false;
            }
            if (modeFilter && r.mode !== modeFilter) {
                return false;
            }
            return true;
        });

        // Sort results
        filtered.sort(function(a, b) {
            var aVal = a[sortColumn] || '';
            var bVal = b[sortColumn] || '';

            if (sortColumn === 'score' || sortColumn === 'size') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            } else {
                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        // Update count
        document.getElementById('resultCount').textContent = filtered.length + ' of ' + allResults.length + ' results';

        // Render table
        var tbody = document.getElementById('resultsBody');
        var noResults = document.getElementById('noResults');

        if (filtered.length === 0) {
            tbody.innerHTML = '';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';

        var html = '';
        filtered.forEach(function(r) {
            var scoreClass = r.score >= 80 ? 'll-score-high' : (r.score >= 60 ? 'll-score-medium' : 'll-score-low');
            var modeClass = 'll-mode-' + r.mode;
            var rowClass = r.blacklisted ? 'blacklisted' : '';

            html += '<tr class="' + rowClass + '" data-url="' + escapeHtml(r.url) + '">';
            html += '<td><span class="ll-score-badge ' + scoreClass + '">' + r.score + '%</span></td>';
            html += '<td><div class="ll-result-title" title="' + escapeHtml(r.title) + '">' + escapeHtml(r.title) + '</div></td>';
            html += '<td>' + escapeHtml(r.provider) + '</td>';
            html += '<td>' + escapeHtml(r.size_display || r.size) + '</td>';
            html += '<td><span class="ll-mode-badge ' + modeClass + '">' + r.mode.toUpperCase() + '</span></td>';
            html += '<td class="ll-result-actions">';

            if (r.blacklisted) {
                html += '<span style="color: var(--ll-text-muted); font-size: 0.875rem;">Blacklisted</span>';
            } else {
                html += '<button class="ll-btn ll-btn-primary ll-btn-sm download-btn" ' +
                        'data-url="' + escapeHtml(r.url) + '" ' +
                        'data-mode="' + escapeHtml(r.mode) + '" ' +
                        'data-provider="' + escapeHtml(r.provider) + '" ' +
                        'data-size="' + escapeHtml(r.size) + '">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">' +
                        '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>' +
                        '<polyline points="7 10 12 15 17 10"></polyline>' +
                        '<line x1="12" y1="15" x2="12" y2="3"></line>' +
                        '</svg> Get</button>';
                html += '<button class="ll-btn ll-btn-danger ll-btn-sm blacklist-btn" ' +
                        'data-url="' + escapeHtml(r.url) + '" ' +
                        'data-title="' + escapeHtml(r.title) + '" ' +
                        'data-provider="' + escapeHtml(r.provider) + '" ' +
                        'title="Block this result from future searches">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">' +
                        '<circle cx="12" cy="12" r="10"></circle>' +
                        '<line x1="15" y1="9" x2="9" y2="15"></line>' +
                        '<line x1="9" y1="9" x2="15" y2="15"></line>' +
                        '</svg> Block</button>';
            }

            html += '</td></tr>';
        });

        tbody.innerHTML = html;

        // Attach event listeners to new buttons
        tbody.querySelectorAll('.download-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                downloadResult(this.dataset);
            });
        });

        tbody.querySelectorAll('.blacklist-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                blacklistResult(this.dataset);
            });
        });
    }

    function downloadResult(data) {
        // Redirect to snatchBook with redirect=interactive to come back here
        var url = 'snatchBook?' +
            'bookid=' + encodeURIComponent(bookid) +
            '&mode=' + encodeURIComponent(data.mode) +
            '&provider=' + encodeURIComponent(data.provider) +
            '&url=' + encodeURIComponent(data.url) +
            '&size=' + encodeURIComponent(data.size) +
            '&library=' + encodeURIComponent(library) +
            '&redirect=interactive';

        window.location.href = url;
    }

    function blacklistResult(data) {
        if (!confirm('Blacklist "' + data.title.substring(0, 50) + '..." from ' + data.provider + '?\n\nThis result will not appear in future searches for this book.')) {
            return;
        }

        $.ajax({
            url: 'blacklistSearchResult',
            data: {
                url: data.url,
                title: data.title,
                provider: data.provider,
                bookid: bookid,
                library: library
            },
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    window.llToast.show('Result blacklisted', 'success');
                    // Mark the result as blacklisted in our data
                    allResults.forEach(function(r) {
                        if (r.url === data.url) {
                            r.blacklisted = true;
                        }
                    });
                    renderResults();
                } else {
                    window.llToast.show('Error: ' + (response.error || 'Unknown error'), 'error');
                }
            },
            error: function() {
                window.llToast.show('Failed to blacklist result', 'error');
            }
        });
    }

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function debounce(func, delay) {
        var timeoutId;
        return function() {
            var args = arguments;
            var context = this;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(function() {
                func.apply(context, args);
            }, delay);
        };
    }
})();
</script>
</%def>

<%inherit file="base.html" />
<%!
    import bookbagofholding
%>
<%
    current_page = 'books'
%>
<%def name="headIncludes()">
    %if bookbagofholding.EBOOK_UPDATE == True or bookbagofholding.POSTPROCESS_UPDATE == True:
    <meta http-equiv="refresh" content="10">
    %endif
    <link href="css/datatables.bootstrap5.min.css" rel="stylesheet">
</%def>
<%def name="styleIncludes()">
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</%def>
<%def name="body()">
    <div class="ll-page-header">
        <div class="ll-page-header-content">
            <h1 class="ll-page-title">Books</h1>
            <p class="ll-page-subtitle">Browse and manage your ebook library</p>
        </div>
        <div class="ll-page-header-actions">
            %if perm&bookbagofholding.perm_force:
            <a href="forceSearch?source=books" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Search
            </a>
            <a href="forceProcess?source=books" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                </svg>
                Post-Process
            </a>
            <button type="button" id="libraryScanBtn" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" class="scan-icon">
                    <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                    <path d="M3 3v5h5"></path>
                    <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                    <path d="M16 21h5v-5"></path>
                </svg>
                <span class="scan-text">Library Scan</span>
            </button>
            %endif
            <a href="bookWall?have=0" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Additions
            </a>
            <a href="bookWall?have=1" class="ll-btn ll-btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Downloads
            </a>
        </div>
    </div>

    %if bookbagofholding.EBOOK_UPDATE == True:
    <div class="ll-alert ll-alert-info" style="margin-bottom: 1.5rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="animation: spin 1s linear infinite;">
            <line x1="12" y1="2" x2="12" y2="6"></line>
            <line x1="12" y1="18" x2="12" y2="22"></line>
            <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
            <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
            <line x1="2" y1="12" x2="6" y2="12"></line>
            <line x1="18" y1="12" x2="22" y2="12"></line>
            <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
            <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
        </svg>
        Library scan in progress...
    </div>
    %endif
    %if bookbagofholding.POSTPROCESS_UPDATE == True:
    <div class="ll-alert ll-alert-info" style="margin-bottom: 1.5rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="animation: spin 1s linear infinite;">
            <line x1="12" y1="2" x2="12" y2="6"></line>
            <line x1="12" y1="18" x2="12" y2="22"></line>
            <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
            <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
            <line x1="2" y1="12" x2="6" y2="12"></line>
            <line x1="18" y1="12" x2="22" y2="12"></line>
            <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
            <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
        </svg>
        Post-processing in progress...
    </div>
    %endif

    <!-- Bulk Actions (shown when items selected) -->
    %if perm&bookbagofholding.perm_status or bookbagofholding.CONFIG.get('USER_ACCOUNTS', False):
    <form id="markBooks" action="markBooks" method="get" style="display: none;" class="ll-mb-3" onsubmit="return false;">
        <input type="hidden" name="booklang" value="${booklang}">
        <input type="hidden" name="redirect" value="books">
        <div class="ll-card">
            <div class="ll-card-body ll-flex ll-items-center ll-gap-3">
                <span id="selectedCount">0 selected</span>
                <select id="action" name="action" class="ll-select" style="width: auto;">
                    %if perm&bookbagofholding.perm_status:
                    <optgroup label="Status">
                        <option value="Wanted">Wanted</option>
                        <option value="Have">Have</option>
                        <option value="Ignored">Ignored</option>
                        <option value="Skipped">Skipped</option>
                    </optgroup>
                    %if bookbagofholding.CONFIG.get('USER_ACCOUNTS', False):
                    <optgroup label="Reading List">
                        <option value="Unread">Unread</option>
                        <option value="Read">Read</option>
                        <option value="ToRead">To Read</option>
                    </optgroup>
                    %endif
                    <optgroup label="Destructive">
                        <option value="Remove">Remove from list</option>
                        <option value="Delete">Delete files</option>
                    </optgroup>
                    %endif
                </select>
                <button type="submit" class="ll-btn ll-btn-primary ll-btn-sm" onclick="validateForm()">Apply</button>
                <button type="button" class="ll-btn ll-btn-ghost ll-btn-sm" id="clearSelection">Cancel</button>
            </div>
        </div>
    </form>
    %endif

    <!-- Toolbar -->
    <div class="ll-toolbar">
        <div class="ll-toolbar-left">
            <div class="ll-view-toggle" data-target="books">
                <button class="ll-view-toggle-btn active" data-view="list" title="List View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <line x1="3" y1="6" x2="3.01" y2="6"></line>
                        <line x1="3" y1="12" x2="3.01" y2="12"></line>
                        <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                </button>
                <button class="ll-view-toggle-btn" data-view="grid" title="Grid View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </button>
            </div>
        </div>
        <div class="ll-toolbar-right">
            %if len(languages) > 1:
            <div class="ll-toolbar-form">
                <label class="ll-toolbar-label">Language:</label>
                <select id="chooselanguage" class="ll-select">
                    <option value="">All</option>
                    %for language in languages:
                    <option value="${language['BookLang']}">${language['BookLang']}</option>
                    %endfor
                </select>
            </div>
            %endif
        </div>
    </div>

    <!-- Grid View -->
    <div id="books-grid" class="ll-media-grid books" style="display: none;">
        <p class="ll-empty-state">Loading books...</p>
    </div>

    <!-- List View (DataTable) -->
    <div id="books-list" class="ll-card">
        <div class="ll-card-body ll-card-body-flush">
            <div class="table-responsive">
                <table class="ll-table" id="book_table">
                    <thead>
                        <tr>
                            %if perm&bookbagofholding.perm_status:
                            <th class="text-center no-sort" style="width: 40px;"><input type="checkbox" onClick="toggleAll(this)" /></th>
                            %else:
                            <th class="hidden"></th>
                            %endif
                            <th class="text-center no-sort" style="width: 60px;">Cover</th>
                            <th>Author</th>
                            <th>Title</th>
                            <th class="text-center" style="width: 80px;">Rating</th>
                            <th class="text-center" style="width: 100px;">Added</th>
                            <th class="text-center" style="width: 120px;">Status</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</%def>
<%def name="javascriptIncludes()">
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/datatables.bootstrap5.min.js"></script>
    <script src="js/natural.js"></script>
    <script src="js/bootbox.min.js"></script>
    <script>
    function toggleAll(source) {
        var checkboxes = document.querySelectorAll('input[class="checkbox"]');
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
        updateBulkActions();
    }

    function updateBulkActions() {
        var count = document.querySelectorAll('input[class="checkbox"]:checked').length;
        var form = document.getElementById('markBooks');
        var countEl = document.getElementById('selectedCount');
        if (form && countEl) {
            if (count > 0) {
                form.style.display = 'block';
                countEl.textContent = count + ' selected';
            } else {
                form.style.display = 'none';
            }
        }
    }

    function truncateOnWord(str, limit) {
        var bits, i;
        if (typeof str !== 'string') { return ''; }
        bits = str.split('');
        if (bits.length > limit) {
            for (i = bits.length - 1; i > -1; --i) {
                if (i > limit) {
                    bits.length = i;
                }
                else if (' ' === bits[i]) {
                    bits.length = i;
                    break;
                }
            }
            bits.push('...');
        }
        return bits.join('');
    }

    function getUrlVars() {
        var vars = {};
        window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
            vars[key] = value;
        });
        return vars;
    }

    function bookinfo(bookid) {
        $.get('getBookInfo', { 'bookid': bookid }, function(data) {
            bootbox.dialog({
                title: 'Book Information',
                message: '<div style="max-height: 60vh; overflow-y: auto;">' + data + '</div>',
                size: 'large',
                buttons: {
                    close: {
                        label: 'Close',
                        className: 'll-btn ll-btn-secondary'
                    }
                }
            });
        });
    }

    $(document).ready(function() {
        $('#chooselanguage').change(function(){
            window.location = 'books?BookLang=' + $(this).val();
        });
        $('#chooselanguage').val(getUrlVars()['BookLang']);

        var show = "" + ${bookbagofholding.CONFIG['BOOK_IMG']};
        var showimg = (show === '1');

        // Clear any old DataTables state
        localStorage.removeItem('DataTables_book_table_' + window.location.pathname);

        var table = $('#book_table').DataTable({
            "bAutoWidth": false,
            "stateSave": false,
            "order": [[ 2, 'asc' ]],
            "columns": [
                { "data": 0, "className": "text-center", "orderable": false,
                    "render": function(data, type, row) {
                        return '<input type="checkbox" name="' + data + '" class="checkbox" />';
                    }
                },
                { "data": 1, "className": "text-center", "orderable": false, "visible": showimg,
                    "render": function(data, type, row) {
                        return '<a href="' + data + '" target="_blank" rel="noreferrer"><img src="' + data + '" alt="Cover" style="max-height: 50px; border-radius: 4px;"></a>';
                    }
                },
                { "data": 2,
                    "render": function(data, type, row) {
                        %if perm&bookbagofholding.perm_authorbooks:
                        return '<a href="authorPage?AuthorID=' + row[8] + '" class="ll-link">' + data + '</a>';
                        %else:
                        return data;
                        %endif
                    }
                },
                { "data": 3,
                    "render": function(data, type, row) {
                        var pre = String(data).split('<');
                        var limit = window.innerWidth / 30;
                        var title = truncateOnWord(pre[0], limit);
                        var tail = String(data).slice(pre[0].length);
                        var btn = '<button onclick="bookinfo(\'' + row[9] + '\')" class="ll-btn ll-btn-link" type="button" ';
                        if (title === pre[0]) { return btn + '>' + title + '</button>' + tail; }
                        return btn + ' title="' + pre[0] + '">' + title + '</button>' + tail;
                    }
                },
                { "data": 4, "className": "text-center",
                    "render": function(data, type, row) {
                        return '<img src="images/' + data + '-stars.png" alt="Rating" style="height: 12px;">';
                    }
                },
                { "data": 5, "className": "text-center",
                    "render": function(data, type, row) {
                        var str = row[10];
                        if (str === "null") { str = ""; }
                        return str;
                    }
                },
                { "data": 6, "className": "text-center",
                    "render": function(data, type, row) {
                        var btn = row[11];
                        var flag = row[13];
                        btn = btn + flag;
                        if (btn.indexOf('Open') >= 0) {
                            return '<a class="ll-badge ll-badge-success" href="openBook?bookid=' + row[9] + '&library=eBook"><i class="fa fa-book"></i> ' + btn + '</a>';
                        }
                        else if (btn.indexOf('Wanted') >= 0) {
                            %if perm&bookbagofholding.perm_force:
                            return '<span class="ll-badge ll-badge-warning">' + btn + '</span><br><a class="ll-badge ll-badge-primary" href="searchForBook?bookid=' + row[9] + '&library=eBook" style="margin-top: 4px;"><i class="fa fa-search"></i> Search</a> <a class="ll-badge ll-badge-info" href="interactiveSearch?bookid=' + row[9] + '&library=eBook" style="margin-top: 4px;" title="Interactive search - pick from all results"><i class="fa fa-list"></i> Pick</a>';
                            %else:
                            return '<a class="ll-badge ll-badge-secondary" href="requestBook?bookid=' + row[9] + '&library=eBook">Request</a>';
                            %endif
                        }
                        else if (btn.indexOf('Snatched') >= 0) {
                            return '<span class="ll-badge ll-badge-info">' + btn + '</span>';
                        }
                        else if (btn.indexOf('Have') >= 0) {
                            %if perm&bookbagofholding.perm_status:
                            return '<span class="ll-badge ll-badge-info">' + btn + '</span>';
                            %else:
                            return '<a class="ll-badge ll-badge-secondary" href="requestBook?bookid=' + row[9] + '&library=eBook">Request</a>';
                            %endif
                        }
                        else {
                            %if perm&bookbagofholding.perm_status:
                            return '<span class="ll-badge ll-badge-secondary">' + btn + '</span>';
                            %else:
                            return '<a class="ll-badge ll-badge-secondary" href="requestBook?bookid=' + row[9] + '&library=eBook">Request</a>';
                            %endif
                        }
                    }
                }
            ],
            "oLanguage": {
                "sSearch": "",
                "sSearchPlaceholder": "Search books...",
                "sLengthMenu": "_MENU_ per page",
                "sEmptyTable": "No books found",
                "sInfo": "Showing _START_ to _END_ of _TOTAL_ books",
                "sInfoEmpty": "Showing 0 to 0 of 0 books",
                "sInfoFiltered": "(filtered from _MAX_ total)"
            },
            "aLengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            "iDisplayLength": ${bookbagofholding.CONFIG['DISPLAYLENGTH']},
            "sPaginationType": "full_numbers",
            "bServerSide": true,
            "sAjaxSource": 'getBooks?source=Books&booklang=${booklang}',
            "bFilter": true,
            "fnRowCallback": function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                %if perm&bookbagofholding.perm_status == 0:
                $('td', nRow).eq(0).addClass("hidden");
                %endif
                return nRow;
            }
        });

        // Style DataTables elements
        $('.dataTables_filter input').addClass('ll-input').attr('placeholder', 'Search books...');
        $('.dataTables_length select').addClass('ll-select');

        // Checkbox change handler for bulk actions
        $('#book_table').on('change', 'input.checkbox', function() {
            updateBulkActions();
        });

        // Clear selection handler
        $('#clearSelection').on('click', function() {
            $('input.checkbox').prop('checked', false);
            $('input[onClick="toggleAll(this)"]').prop('checked', false);
            updateBulkActions();
        });

        // Load grid view data
        loadGridView();

        // Library scan button handler
        $('#libraryScanBtn').on('click', function() {
            var btn = $(this);
            var icon = btn.find('.scan-icon');
            var text = btn.find('.scan-text');

            // Disable button and show loading state
            btn.prop('disabled', true);
            icon.css('animation', 'spin 1s linear infinite');
            text.text('Scanning...');

            $.ajax({
                url: 'libraryScan',
                data: { library: 'eBook', ajax: '1' },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        if (window.llToast) {
                            window.llToast.show(response.message, 'success');
                        }
                        // Reload the page to show the progress indicator
                        setTimeout(function() {
                            window.location.reload();
                        }, 500);
                    } else {
                        if (window.llToast) {
                            window.llToast.show('Error: ' + (response.error || 'Unknown error'), 'error');
                        }
                        // Re-enable button on error
                        btn.prop('disabled', false);
                        icon.css('animation', '');
                        text.text('Library Scan');
                    }
                },
                error: function() {
                    if (window.llToast) {
                        window.llToast.show('Failed to start library scan', 'error');
                    }
                    // Re-enable button on error
                    btn.prop('disabled', false);
                    icon.css('animation', '');
                    text.text('Library Scan');
                }
            });
        });
    });

    function loadGridView() {
        $.get('getBooks?source=Books&booklang=${booklang}&format=grid', function(response) {
            var gridHtml = '';
            if (response.aaData && response.aaData.length > 0) {
                for (var i = 0; i < response.aaData.length; i++) {
                    var book = response.aaData[i];
                    var bookId = book[9];
                    var cover = book[1];
                    var author = book[2];
                    var title = book[3].split('<')[0];
                    var status = book[11];
                    var statusClass = 'secondary';
                    if (status.indexOf('Open') >= 0) statusClass = 'success';
                    else if (status.indexOf('Wanted') >= 0) statusClass = 'warning';
                    else if (status.indexOf('Snatched') >= 0) statusClass = 'info';

                    gridHtml += '<div class="ll-media-card" data-book-id="' + bookId + '">' +
                        %if perm&bookbagofholding.perm_status or bookbagofholding.CONFIG.get('USER_ACCOUNTS', False):
                        '<label class="ll-card-checkbox" onclick="event.stopPropagation();"><input type="checkbox" name="' + bookId + '" class="checkbox" onchange="updateBulkActions()"><span class="ll-checkbox-mark"></span></label>' +
                        %endif
                        '<div class="ll-media-card-cover" style="background-image: url(\'' + cover + '\'); background-size: cover; background-position: center;">' +
                        '<img src="' + cover + '" alt="' + title + '" onerror="this.src=\'images/nocover.png\'">' +
                        '<span class="ll-badge ll-badge-' + statusClass + ' ll-media-card-badge" style="top: auto; bottom: 8px; left: 8px; right: auto;">' + status + '</span>' +
                        '</div>' +
                        '<div class="ll-media-card-info">' +
                        '<div class="ll-media-card-title" title="' + title + '">' + title + '</div>' +
                        '<div class="ll-media-card-meta">' + author + '</div>' +
                        '</div>' +
                        '</div>';
                }
            } else {
                gridHtml = '<p class="ll-empty-state">No books found</p>';
            }
            $('#books-grid').html(gridHtml);
        });
    }

    function validateForm() {
        var x = document.forms["markBooks"]["action"].value;
        var c = document.querySelectorAll('input[class="checkbox"]:checked').length;

        function submitWithCheckboxes() {
            var form = document.getElementById("markBooks");
            // Remove any previously added hidden book inputs
            var oldInputs = form.querySelectorAll('input.book-checkbox-hidden');
            oldInputs.forEach(function(el) { el.remove(); });

            // Collect checked checkboxes and add as hidden inputs
            var checked = document.querySelectorAll('input[class="checkbox"]:checked');
            checked.forEach(function(checkbox) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = checkbox.name;
                input.value = 'on';
                input.className = 'book-checkbox-hidden';
                form.appendChild(input);
            });

            form.submit();
        }

        if (c > 0 && x === "Delete") {
            var msg = (c === 1)
                ? "Are you sure you want to permanently delete the selected book?"
                : "Are you sure you want to permanently delete the " + c + " selected books?";
            bootbox.confirm({
                message: msg,
                buttons: {
                    confirm: { label: 'Yes', className: 'll-btn ll-btn-danger' },
                    cancel: { label: 'No', className: 'll-btn ll-btn-secondary' }
                },
                callback: function(result) {
                    if (result) { submitWithCheckboxes(); }
                }
            });
            return false;
        }
        submitWithCheckboxes();
    }
    </script>
</%def>
